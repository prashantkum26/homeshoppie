// Enterprise-Grade Prisma Schema - Comprehensive Improvements
// Addresses: Security, Performance, Consistency, Best Practices

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER MANAGEMENT & AUTHENTICATION
// ============================================================================

model User {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  
  // Basic Profile - Validated & Secure
  email             String    @unique
  emailVerified     DateTime?
  name              String?
  phone             String?   // Should validate: /^[\+]?[\d\s\-\(\)]{10,15}$/
  
  // Security Fields - Properly Annotated
  passwordHash      String?   // @encrypt - Bcrypt hashed password
  passwordSalt      String?   // @encrypt - Password salt
  
  // Profile & Preferences
  image             String?   // Profile image URL
  role              Role      @default(USER)
  locale            String    @default("en")
  timezone          String    @default("UTC")
  
  // Account Security
  defaultAddressId  String?   @db.ObjectId
  isActive          Boolean   @default(true)
  isLocked          Boolean   @default(false)
  lockUntil         DateTime?
  lockReason        String?
  failedLoginCount  Int       @default(0)
  
  // Activity Tracking
  lastLoginAt       DateTime?
  lastLoginIp       String?
  passwordChangedAt DateTime?
  emailChangedAt    DateTime?
  
  // Soft Delete Support
  deletedAt         DateTime?
  deletedBy         String?   @db.ObjectId
  deletedReason     String?
  
  // Audit Trail
  version           Int       @default(1)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  createdBy         String?   @db.ObjectId
  updatedBy         String?   @db.ObjectId

  // Relations
  accounts           Account[]
  sessions           Session[]
  addresses          Address[]
  orders             Order[]
  cartItems          CartItem[]
  wishlist           Wishlist[]
  savedForLater      SavedForLater[]
  securityLogs       SecurityLog[]
  rateLimits         RateLimit[]
  userActivityLogs   UserActivityLog[]
  createdProducts    Product[] @relation("ProductCreatedBy")
  updatedProducts    Product[] @relation("ProductUpdatedBy")

  // Indexes for Performance
  @@index([email])
  @@index([phone])
  @@index([isActive])
  @@index([role])
  @@index([createdAt])
  @@index([lastLoginAt])
  @@index([isLocked, lockUntil])
  
  @@map("users")
}

model UserActivityLog {
  id          String           @id @default(auto()) @map("_id") @db.ObjectId
  userId      String           @db.ObjectId
  action      UserActivity
  resource    String?          // Table/Resource affected
  resourceId  String?          @db.ObjectId
  oldValues   Json?            @map("old_values")
  newValues   Json?            @map("new_values")
  ipAddress   String
  userAgent   String?
  sessionId   String?
  metadata    Json?
  createdAt   DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@index([ipAddress, createdAt])
  @@index([resource, resourceId])
  
  @@map("user_activity_logs")
}

model SecurityLog {
  id          String           @id @default(auto()) @map("_id") @db.ObjectId
  userId      String?          @db.ObjectId
  action      SecurityAction
  ipAddress   String
  userAgent   String?
  details     Json?
  severity    SecuritySeverity @default(LOW)
  blocked     Boolean          @default(false)
  resolved    Boolean          @default(false)
  resolvedBy  String?          @db.ObjectId
  resolvedAt  DateTime?
  createdAt   DateTime         @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([action, severity])
  @@index([ipAddress, createdAt])
  @@index([blocked, resolved])
  @@index([severity, createdAt])
  
  @@map("security_logs")
}

model RateLimit {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String?  @db.ObjectId
  ipAddress   String
  endpoint    String
  requests    Int      @default(1)
  windowStart DateTime @default(now())
  windowEnd   DateTime
  blocked     Boolean  @default(false)
  resetAt     DateTime?

  user User? @relation(fields: [userId], references: [id])

  @@unique([ipAddress, endpoint])
  @@index([userId, endpoint, windowStart])
  @@index([ipAddress, endpoint, windowStart])
  @@index([blocked, windowEnd])
  
  @@map("rate_limits")
}

// ============================================================================
// AUTHENTICATION & AUTHORIZATION (NextAuth.js)
// ============================================================================

model Account {
  id                String  @id @default(auto()) @map("_id") @db.ObjectId
  userId            String  @db.ObjectId
  type              String
  provider          String
  providerAccountId String
  
  // OAuth Tokens - Should be encrypted in production
  refreshToken      String? @map("refresh_token")    // @encrypt
  accessToken       String? @map("access_token")     // @encrypt
  idToken           String? @map("id_token")         // @encrypt
  
  // Token Metadata
  expiresAt         Int?    @map("expires_at")
  tokenType         String? @map("token_type")
  scope             String?
  sessionState      String? @map("session_state")
  
  // Security & Audit
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  lastUsedAt        DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@index([provider])
  
  @@map("accounts")
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique @map("session_token")
  userId       String   @db.ObjectId
  expires      DateTime
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  lastUsedAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expires])
  
  @@map("sessions")
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String   @unique
  expires    DateTime
  type       TokenType @default(EMAIL_VERIFICATION)
  used       Boolean   @default(false)
  usedAt     DateTime?
  createdAt  DateTime  @default(now())

  @@unique([identifier, token])
  @@index([expires, used])
  
  @@map("verification_tokens")
}

// ============================================================================
// PRODUCT CATALOG & INVENTORY
// ============================================================================

model Category {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  name        String    @unique
  description String?
  image       String?
  slug        String    @unique
  parentId    String?   @db.ObjectId
  
  // SEO & Marketing
  metaTitle       String?
  metaDescription String?
  keywords        String[]
  
  // Display & Ordering
  sortOrder   Int       @default(0)
  isActive    Boolean   @default(true)
  isVisible   Boolean   @default(true)
  
  // Soft Delete
  deletedAt   DateTime?
  deletedBy   String?   @db.ObjectId
  
  // Audit
  version     Int       @default(1)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String?   @db.ObjectId
  updatedBy   String?   @db.ObjectId

  // Relations
  products   Product[]
  parent     Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children   Category[] @relation("CategoryHierarchy")

  @@index([slug])
  @@index([parentId])
  @@index([isActive, isVisible])
  @@index([sortOrder])
  
  @@map("categories")
}

model Product {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  description   String
  shortDescription String?
  
  // Pricing - Using Decimal for precision
  price         Decimal   @db.Decimal
  compareAtPrice Decimal? @map("compare_at_price") @db.Decimal
  cost          Decimal?  @db.Decimal  // Cost basis for margin calculation
  
  // Product Organization
  sku           String?   @unique
  barcode       String?
  slug          String    @unique
  categoryId    String    @db.ObjectId
  
  // Inventory Management
  stock         Int       @default(0)
  lowStockThreshold Int   @default(10)
  trackInventory Boolean  @default(true)
  allowBackorder Boolean  @default(false)
  
  // Physical Properties
  weight        Decimal?  @db.Decimal
  weightUnit    WeightUnit @default(GRAMS)
  dimensions    Json?     // {length, width, height, unit}
  
  // Product Attributes
  tags          String[]
  images        String[]  // Array of image IDs
  
  // SEO & Marketing
  metaTitle       String?
  metaDescription String?
  searchKeywords  String[]
  
  // Status & Visibility
  status        ProductStatus @default(DRAFT)
  isActive      Boolean   @default(true)
  isVisible     Boolean   @default(true)
  isFeatured    Boolean   @default(false)
  
  // Soft Delete
  deletedAt     DateTime?
  deletedBy     String?   @db.ObjectId
  deletedReason String?
  
  // Audit Trail
  version       Int       @default(1)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdBy     String?   @db.ObjectId
  updatedBy     String?   @db.ObjectId

  // Relations
  category          Category  @relation(fields: [categoryId], references: [id])
  cartItems         CartItem[]
  orderItems        OrderItem[]
  productImages     Image[]          @relation("ProductImages")
  wishlist          Wishlist[]
  savedForLater     SavedForLater[]
  priceHistory      ProductPriceHistory[]
  inventoryLogs     InventoryLog[]
  
  // Relation to track who created/updated
  creator           User?     @relation("ProductCreatedBy", fields: [createdBy], references: [id])
  updater           User?     @relation("ProductUpdatedBy", fields: [updatedBy], references: [id])

  // Performance Indexes
  @@index([categoryId])
  @@index([slug])
  @@index([sku])
  @@index([isActive, isVisible])
  @@index([isFeatured])
  @@index([status])
  @@index([price])
  @@index([stock])
  @@index([createdAt])
  @@index([name]) // For text search (consider MongoDB text index)
  
  @@map("products")
}

model ProductPriceHistory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  productId String   @db.ObjectId
  oldPrice  Decimal  @db.Decimal
  newPrice  Decimal  @db.Decimal
  reason    String?  // "promotion", "cost_change", "market_adjustment"
  changedBy String   @db.ObjectId
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, createdAt])
  
  @@map("product_price_history")
}

model InventoryLog {
  id         String      @id @default(auto()) @map("_id") @db.ObjectId
  productId  String      @db.ObjectId
  type       InventoryMovement
  quantity   Int
  oldStock   Int
  newStock   Int
  reason     String?
  reference  String?     // Order ID, adjustment ID, etc.
  notes      String?
  createdBy  String      @db.ObjectId
  createdAt  DateTime    @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, createdAt])
  @@index([type, createdAt])
  
  @@map("inventory_logs")
}

// ============================================================================
// MEDIA & FILE MANAGEMENT
// ============================================================================

model Image {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // External Service Integration
  serviceImageId   String   @unique
  serviceName      String   @default("homeshoppie-service")
  
  // File Information
  filename         String
  originalName     String
  mimeType         String
  fileSize         BigInt   @map("file_size") // Using BigInt for large files
  
  // Image Dimensions
  width            Int?
  height           Int?
  aspectRatio      Decimal? @db.Decimal
  
  // SEO & Accessibility
  alt              String?
  title            String?
  description      String?
  
  // Organization
  category         String?
  tags             String[]
  
  // Access Control
  isPublic         Boolean  @default(true)
  accessLevel      AccessLevel @default(PUBLIC)
  
  // Service URLs - Should validate URL format
  serviceUrl       String
  publicUrl        String
  thumbnailUrl     String?
  smallUrl         String?
  mediumUrl        String?
  largeUrl         String?
  
  // Variants & Processing
  variants         Json?
  processingStatus ProcessingStatus @default(COMPLETED)
  
  // Security - Should be encrypted
  accessToken      String?  // @encrypt
  
  // Relations
  productId        String?  @db.ObjectId
  product          Product? @relation("ProductImages", fields: [productId], references: [id])
  
  // Upload Tracking & Audit
  uploadedBy       String   @db.ObjectId
  uploadedByEmail  String
  uploadedFrom     String?  // IP address
  
  // Soft Delete
  deletedAt        DateTime?
  deletedBy        String?  @db.ObjectId
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([serviceImageId])
  @@index([productId])
  @@index([uploadedBy])
  @@index([isPublic, accessLevel])
  @@index([category])
  @@index([createdAt])
  
  @@map("images")
}

// ============================================================================
// USER DATA & PREFERENCES
// ============================================================================

model Address {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  userId     String  @db.ObjectId
  
  // Contact Information
  name       String
  phone      String  // Should validate phone format
  email      String?
  
  // Address Details
  street1    String  @map("street_1")
  street2    String? @map("street_2")
  city       String
  state      String
  postalCode String  @map("postal_code")
  country    String  @default("IN")
  landmark   String?
  
  // Address Type & Preferences
  type       AddressType @default(HOME)
  isDefault  Boolean     @default(false)
  
  // Validation & Verification
  isValidated Boolean @default(false)
  validatedAt DateTime?
  
  // Soft Delete
  deletedAt  DateTime?
  deletedBy  String?   @db.ObjectId
  
  // Audit
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]

  @@index([userId])
  @@index([isDefault])
  @@index([type])
  @@index([country, state, city])
  
  @@map("addresses")
}

model CartItem {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  productId  String   @db.ObjectId
  quantity   Int      @default(1)
  
  // Price at time of adding (for reference)
  priceSnapshot Decimal? @db.Decimal
  
  // Session & Tracking
  sessionId  String?
  addedFrom  String?  // "product_page", "search", "recommendation"
  
  // Soft Delete (for abandoned cart analysis)
  deletedAt  DateTime?
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId, createdAt])
  @@index([productId])
  @@index([sessionId])
  
  @@map("cart_items")
}

model Wishlist {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  productId String   @db.ObjectId
  
  // Wishlist Management
  notes     String?
  priority  Int      @default(1) // 1=high, 5=low
  
  // Tracking
  addedFrom String?  // Where item was added from
  
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId, createdAt])
  @@index([productId])
  @@index([priority])
  
  @@map("wishlist")
}

model SavedForLater {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  productId String   @db.ObjectId
  quantity  Int      @default(1)
  
  // Context
  savedFrom String?  // "cart", "checkout"
  notes     String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId, createdAt])
  
  @@map("saved_for_later")
}

// ============================================================================
// ORDER MANAGEMENT & FULFILLMENT
// ============================================================================

model Order {
  id              String      @id @default(auto()) @map("_id") @db.ObjectId
  orderNumber     String      @unique
  userId          String      @db.ObjectId
  addressId       String      @db.ObjectId
  
  // Order Status & Processing
  status          OrderStatus @default(PENDING)
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)
  
  // Payment Information
  paymentMethod   String
  paymentStatus   PaymentStatus @default(PENDING)
  paymentIntentId String?
  
  // Financial Calculations - Using Decimal for precision
  subtotalAmount  Decimal     @db.Decimal
  taxAmount       Decimal     @default(0) @db.Decimal
  shippingFee     Decimal     @default(0) @db.Decimal
  discountAmount  Decimal     @default(0) @db.Decimal
  totalAmount     Decimal     @db.Decimal
  
  // Tax Details
  taxBreakdown    Json?       // Detailed tax calculation
  taxRate         Decimal?    @db.Decimal
  
  // Shipping & Delivery
  shippingMethod  String?
  trackingNumber  String?
  estimatedDelivery DateTime?
  deliveredAt     DateTime?
  
  // Order Metadata
  notes           String?
  internalNotes   String?     // Staff-only notes
  source          String?     // "web", "mobile", "admin"
  
  // Cancellation & Returns
  cancelledAt     DateTime?
  cancelledBy     String?     @db.ObjectId
  cancelReason    String?
  
  // Soft Delete
  deletedAt       DateTime?
  deletedBy       String?     @db.ObjectId
  
  // Audit Trail
  version         Int         @default(1)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  user         User         @relation(fields: [userId], references: [id])
  address      Address      @relation(fields: [addressId], references: [id])
  orderItems   OrderItem[]
  paymentLogs  PaymentLog[]
  orderHistory OrderHistory[]

  // Performance Indexes
  @@index([userId, createdAt])
  @@index([orderNumber])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@index([fulfillmentStatus])
  
  @@map("orders")
}

model OrderItem {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  orderId     String  @db.ObjectId
  productId   String  @db.ObjectId
  
  // Item Details (Snapshot at order time)
  name        String
  sku         String?
  quantity    Int
  unitPrice   Decimal @db.Decimal
  totalPrice  Decimal @db.Decimal
  
  // Product Snapshot
  productSnapshot Json? // Full product details at order time
  
  // Fulfillment
  fulfilled   Boolean @default(false)
  fulfilledAt DateTime?

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  
  @@map("order_items")
}

model OrderHistory {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  orderId     String      @db.ObjectId
  status      OrderStatus
  notes       String?
  changedBy   String      @db.ObjectId
  createdAt   DateTime    @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, createdAt])
  
  @@map("order_history")
}

// ============================================================================
// PAYMENT PROCESSING & FINANCIAL
// ============================================================================

model PaymentLog {
  id                String        @id @default(auto()) @map("_id") @db.ObjectId
  orderId           String        @db.ObjectId
  
  // External Payment Gateway
  razorpayOrderId   String?
  razorpayPaymentId String?
  signature         String?       // @encrypt - Payment signature
  
  // Payment Details - Using Decimal for precision
  amount            Decimal       @db.Decimal
  currency          String        @default("INR")
  
  // Payment Processing
  status            PaymentStatus @default(PENDING)
  method            String?       // "card", "upi", "netbanking", "wallet"
  gateway           String        @default("razorpay")
  
  // Gateway Response - Should be encrypted
  gatewayResponse   Json?         // @encrypt
  
  // Error Handling & Retry
  failureReason     String?
  failureCode       String?
  retryCount        Int           @default(0)
  attemptNumber     Int           @default(1)
  maxRetries        Int           @default(3)
  
  // Security & Audit
  ipAddress         String?
  userAgent         String?
  
  // Reconciliation
  reconciledAt      DateTime?
  reconciledBy      String?       @db.ObjectId
  
  // Audit Trail
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  order Order @relation(fields: [orderId], references: [id])

  // Compound indexes for common queries
  @@index([orderId, status, createdAt])
  @@index([status, gateway, createdAt])
  @@index([razorpayOrderId])
  @@index([razorpayPaymentId])
  @@index([createdAt])
  
  @@map("payment_logs")
}

// ============================================================================
// TAX & COMPLIANCE
// ============================================================================

model TaxConfiguration {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  name          String      @unique
  type          TaxType
  rate          Decimal     @db.Decimal  // More precise than Float
  
  // Applicability Rules
  isActive      Boolean     @default(true)
  applicableIn  String[]    // States/regions
  productTypes  String[]    // Product categories
  
  // Amount Thresholds
  minAmount     Decimal?    @db.Decimal
  maxAmount     Decimal?    @db.Decimal
  
  // Validity Period
  validFrom     DateTime    @default(now())
  validUntil    DateTime?
  
  // Compliance & Audit
  regulationRef String?     // Government regulation reference
  lastUpdated   DateTime    @updatedAt
  updatedBy     String?     @db.ObjectId
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([isActive, validFrom, validUntil])
  @@index([type])
  
  @@map("tax_configurations")
}

// ============================================================================
// ENUMS - Standardized Naming
// ============================================================================

enum Role {
  USER
  ADMIN
  MODERATOR
  SUPER_ADMIN
}

enum OrderStatus {
  DRAFT
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIAL
  FULFILLED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  PAID
  FAILED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum ProductStatus {
  DRAFT
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum SecurityAction {
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGOUT
  PASSWORD_CHANGE
  EMAIL_CHANGE
  ACCOUNT_LOCKED
  ACCOUNT_UNLOCKED
  SUSPICIOUS_ACTIVITY
  API_ACCESS
  UNAUTHORIZED_ACCESS
  DATA_BREACH_ATTEMPT
  PAYMENT_FRAUD
}

enum SecuritySeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum UserActivity {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
}

enum TaxType {
  PERCENTAGE
  FIXED_AMOUNT
  GST
  CGST
  SGST
  IGST
  STATE_TAX
  CITY_TAX
}

enum AddressType {
  HOME
  WORK
  OFFICE
  OTHER
}

enum WeightUnit {
  GRAMS
  KILOGRAMS
  POUNDS
  OUNCES
}

enum AccessLevel {
  PUBLIC
  PRIVATE
  RESTRICTED
  INTERNAL
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
  PHONE_VERIFICATION
  TWO_FACTOR_AUTH
}

enum InventoryMovement {
  SALE
  PURCHASE
  ADJUSTMENT
  RETURN
  TRANSFER
  DAMAGED
  EXPIRED
}
